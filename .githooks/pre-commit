#!/bin/bash
# Pre-commit hook to protect production plugins from accidental changes

set -e

HOOK_DIR="$(dirname "$0")"
REPO_ROOT="$(cd "$HOOK_DIR/.." && pwd)"

# Color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Track if we found any issues
FOUND_WARNINGS=0
FOUND_ERRORS=0

echo "üîí Checking for changes to production plugins..."

# Get list of plugins in marketplace
MARKETPLACE_FILE="$REPO_ROOT/.claude-plugin/marketplace.json"
if [ ! -f "$MARKETPLACE_FILE" ]; then
    echo -e "${YELLOW}‚ö† Warning: marketplace.json not found${NC}"
    exit 0
fi

# Extract plugin names from marketplace (production plugins)
PRODUCTION_PLUGINS=$(jq -r '.plugins[].name' "$MARKETPLACE_FILE" 2>/dev/null)

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

# Check each staged file
for FILE in $STAGED_FILES; do
    # Check if file is in a production plugin directory
    for PLUGIN in $PRODUCTION_PLUGINS; do
        if [[ "$FILE" == plugins/$PLUGIN/* ]]; then
            # Check if this is a manifest/version file change
            if [[ "$FILE" =~ (manifest\.json|plugin\.json)$ ]]; then
                # Get current version from marketplace
                MARKETPLACE_VERSION=$(jq -r ".plugins[] | select(.name == \"$PLUGIN\") | .version" "$MARKETPLACE_FILE")

                # Get version from plugin file
                PLUGIN_VERSION=$(jq -r '.version' "$REPO_ROOT/$FILE" 2>/dev/null || echo "unknown")

                if [ "$PLUGIN_VERSION" = "$MARKETPLACE_VERSION" ]; then
                    echo -e "${RED}‚úó ERROR: Modifying production plugin '$PLUGIN' without version bump${NC}"
                    echo -e "${YELLOW}  Current version: $MARKETPLACE_VERSION${NC}"
                    echo -e "${YELLOW}  You must bump the version before modifying a production plugin${NC}"
                    FOUND_ERRORS=1
                else
                    echo -e "${GREEN}‚úì Version bump detected: $MARKETPLACE_VERSION ‚Üí $PLUGIN_VERSION${NC}"

                    # Check if marketplace.json was also updated
                    if ! echo "$STAGED_FILES" | grep -q "\.claude-plugin/marketplace\.json"; then
                        echo -e "${YELLOW}‚ö† Warning: Plugin version changed but marketplace.json not staged${NC}"
                        echo -e "${YELLOW}  Remember to update marketplace.json with new plugin version${NC}"
                        FOUND_WARNINGS=1
                    fi
                fi
            else
                # Non-version file change in production plugin
                echo -e "${YELLOW}‚ö† Warning: Modifying production plugin: $PLUGIN${NC}"
                echo -e "${YELLOW}  File: $FILE${NC}"
                FOUND_WARNINGS=1
            fi
        fi
    done

    # Check marketplace.json changes
    if [[ "$FILE" == ".claude-plugin/marketplace.json" ]]; then
        echo -e "${YELLOW}üìù Marketplace catalog modified${NC}"

        # Check if marketplace version was bumped
        CURRENT_MARKET_VERSION=$(git show HEAD:.claude-plugin/marketplace.json 2>/dev/null | jq -r '.version' 2>/dev/null || echo "1.0.0")
        NEW_MARKET_VERSION=$(jq -r '.version' "$MARKETPLACE_FILE")

        if [ "$CURRENT_MARKET_VERSION" = "$NEW_MARKET_VERSION" ]; then
            echo -e "${YELLOW}‚ö† Warning: Marketplace catalog changed but version not bumped${NC}"
            echo -e "${YELLOW}  Current: $CURRENT_MARKET_VERSION${NC}"
            echo -e "${YELLOW}  Consider bumping marketplace version (Minor for new plugins, Patch for updates)${NC}"
            FOUND_WARNINGS=1
        else
            echo -e "${GREEN}‚úì Marketplace version bump: $CURRENT_MARKET_VERSION ‚Üí $NEW_MARKET_VERSION${NC}"
        fi
    fi
done

# Check for development plugins that might be ready for production
DEV_PLUGIN_DIRS=$(find "$REPO_ROOT/plugins-dev" -maxdepth 1 -type d 2>/dev/null | tail -n +2)
if [ -n "$DEV_PLUGIN_DIRS" ]; then
    for DEV_DIR in $DEV_PLUGIN_DIRS; do
        PLUGIN_NAME=$(basename "$DEV_DIR")
        if echo "$STAGED_FILES" | grep -q "plugins-dev/$PLUGIN_NAME"; then
            echo -e "${YELLOW}üí° Development plugin modified: $PLUGIN_NAME${NC}"
            echo -e "${YELLOW}   Ready for production? Run: ./scripts/promote-plugin.sh $PLUGIN_NAME${NC}"
        fi
    done
fi

echo ""

# Final decision
if [ $FOUND_ERRORS -gt 0 ]; then
    echo -e "${RED}‚ùå Commit blocked: Fix errors above before committing${NC}"
    echo ""
    echo "To modify a production plugin:"
    echo "  1. Bump version in plugin manifest (plugins/name/.claude-plugin/plugin.json)"
    echo "  2. Update version in marketplace catalog (.claude-plugin/marketplace.json)"
    echo "  3. Document changes in plugin's README.md or CHANGELOG.md"
    echo "  4. Stage all changes and commit"
    echo ""
    echo "To bypass this hook (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    exit 1
fi

if [ $FOUND_WARNINGS -gt 0 ]; then
    echo -e "${YELLOW}‚ö† Warnings detected - please review changes carefully${NC}"
    echo -e "${YELLOW}Proceed with commit? [y/N]${NC} "

    # In non-interactive mode, allow commit with warnings
    if [ ! -t 0 ]; then
        echo "Non-interactive mode - allowing commit with warnings"
        exit 0
    fi

    read -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${RED}Commit cancelled${NC}"
        exit 1
    fi
fi

echo -e "${GREEN}‚úì All checks passed${NC}"
exit 0
