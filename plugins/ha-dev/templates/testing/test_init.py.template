"""Test setup and unload for {integration_name}.

Tests integration lifecycle:
- Successful setup
- Setup failure (ConfigEntryNotReady)
- Successful unload
"""
from __future__ import annotations

from unittest.mock import AsyncMock

import pytest
from homeassistant.config_entries import ConfigEntryState
from homeassistant.core import HomeAssistant
from pytest_homeassistant_custom_component.common import MockConfigEntry

from custom_components.{domain}.const import DOMAIN

from .conftest import MOCK_CONFIG


async def test_setup_entry(
    hass: HomeAssistant,
    mock_client: AsyncMock,
) -> None:
    """Test successful setup."""
    entry = MockConfigEntry(
        domain=DOMAIN,
        data=MOCK_CONFIG,
        unique_id="test_unique_id",
    )
    entry.add_to_hass(hass)

    await hass.config_entries.async_setup(entry.entry_id)
    await hass.async_block_till_done()

    assert entry.state is ConfigEntryState.LOADED


async def test_setup_entry_not_ready(
    hass: HomeAssistant,
    mock_client: AsyncMock,
) -> None:
    """Test setup fails and retries when device is unavailable."""
    # Make the connection fail
    mock_client.async_get_data.side_effect = ConnectionError("Device offline")

    entry = MockConfigEntry(
        domain=DOMAIN,
        data=MOCK_CONFIG,
        unique_id="test_unique_id",
    )
    entry.add_to_hass(hass)

    await hass.config_entries.async_setup(entry.entry_id)
    await hass.async_block_till_done()

    # Should be in retry state, not failed
    assert entry.state is ConfigEntryState.SETUP_RETRY


async def test_unload_entry(
    hass: HomeAssistant,
    mock_client: AsyncMock,
) -> None:
    """Test successful unload."""
    entry = MockConfigEntry(
        domain=DOMAIN,
        data=MOCK_CONFIG,
        unique_id="test_unique_id",
    )
    entry.add_to_hass(hass)

    await hass.config_entries.async_setup(entry.entry_id)
    await hass.async_block_till_done()
    assert entry.state is ConfigEntryState.LOADED

    await hass.config_entries.async_unload(entry.entry_id)
    await hass.async_block_till_done()
    assert entry.state is ConfigEntryState.NOT_LOADED


async def test_setup_and_unload_multiple_entries(
    hass: HomeAssistant,
    mock_client: AsyncMock,
) -> None:
    """Test multiple config entries can coexist."""
    entry1 = MockConfigEntry(
        domain=DOMAIN,
        data={**MOCK_CONFIG, "host": "192.168.1.101"},
        unique_id="device_1",
    )
    entry2 = MockConfigEntry(
        domain=DOMAIN,
        data={**MOCK_CONFIG, "host": "192.168.1.102"},
        unique_id="device_2",
    )
    entry1.add_to_hass(hass)
    entry2.add_to_hass(hass)

    await hass.config_entries.async_setup(entry1.entry_id)
    await hass.config_entries.async_setup(entry2.entry_id)
    await hass.async_block_till_done()

    assert entry1.state is ConfigEntryState.LOADED
    assert entry2.state is ConfigEntryState.LOADED

    await hass.config_entries.async_unload(entry1.entry_id)
    await hass.async_block_till_done()

    assert entry1.state is ConfigEntryState.NOT_LOADED
    assert entry2.state is ConfigEntryState.LOADED
